
import json
import logging
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from scriptpulse.runner import run_pipeline

# Configure logging
logging.basicConfig(level=logging.ERROR)

def run_test_case(title, script_type, content):
    print(f"Analyzing: {title}...")
    try:
        result = run_pipeline(content, lens='viewer', genre='drama', experimental_mode=True)
        return result
    except Exception as e:
        print(f"ERROR processing {title}: {e}")
        return None

# =============================================================================
# TEST CASES (Copied from run_validation_suite.py)
# =============================================================================

test_cases = [
    {
        "title": "The Escape",
        "type": "Feature Film",
        "content": """
INT. FACTORY - DAY

Sparks fly. Metal SCREECHES.

JOHN (40s) wipes grease from his face.

JOHN
(grunting)
Just one more turn.

He wrenches the lever. A hiss of steam.

EXT. ALLEY - CONTINUOUS

John bursts out the door. Running.
"""
    },
    {
        "title": "Stream Wars",
        "type": "Web Series",
        "content": """
INT. COFFEE SHOP - DAY

JESS and MARK sit at a table.

JESS
So you're saying it's over? Just like that? After three years of sharing a Netflix account?

MARK
It's not about the Netflix, Jess. It's about the Hulu. You never watch Hulu.

JESS
I watch The Bear!

MARK
You watched one episode! One!
"""
    },
    {
        "title": "The Diagnosis",
        "type": "TV Drama",
        "content": """
INT. HOSPITAL ROOM - NIGHT

MONITOR BEEPS steadily.

DOCTOR EVANS looks at the chart. Looks at SARAH.

DOCTOR EVANS
I'm afraid the results aren't what we hoped for.

Sarah stares at the wall.

SARAH
How long?

DOCTOR EVANS
Months. Maybe less.
"""
    },
     {
        "title": "Hamlet",
        "type": "Stage Play",
        "content": """
INT. STAGE - NIGHT

HAMLET stands alone. Center stage. Spotlight.

HAMLET
To be, or not to be, that is the question:
Whether 'tis nobler in the mind to suffer
The slings and arrows of outrageous fortune,
Or to take arms against a sea of troubles
And by opposing end them. To die—to sleep,
No more; and by a sleep to say we end
The heart-ache and the thousand natural shocks
That flesh is heir to: 'tis a consummation
Devoutly to be wish'd.
"""
    }
]

# =============================================================================
# REPORT GENERATION
# =============================================================================

report_lines = []
report_lines.append("# ScriptPulse Ethics & Agency Report")
report_lines.append("Generated by: EthicsAgent v14.0 (Consolidated)")
report_lines.append("")
report_lines.append("> **Note:** This report focuses exclusively on Character Agency, Fairness, and Representation metrics which are calculated by the Ethics Agent but typically summarized in standard validation outputs.")
report_lines.append("")

for case in test_cases:
    res = run_test_case(case['title'], case['type'], case['content'])
    if not res:
        continue

    agency_data = res.get('agency_analysis', {})
    fairness_data = res.get('fairness_audit', {})

    report_lines.append(f"## {case['title']} ({case['type']})")
    
    # 1. Agency Scores
    report_lines.append("### Agency Analysis")
    metrics = agency_data.get('agency_metrics', [])
    if metrics:
        report_lines.append("| Character | Agency Score | Centrality | Active Verbs | Classification |")
        report_lines.append("| :--- | :--- | :--- | :--- | :--- |")
        for m in metrics:
            report_lines.append(f"| **{m.get('character', 'Unknown')}** | {m.get('agency_score', 0.0):.2f} | {m.get('centrality', 0.0):.2f} | {m.get('active_verb_ratio', 0.0):.2f} | {m.get('classification', 'N/A')} |")
    else:
        report_lines.append("_No characters detected or insufficient data for agency analysis._")
    
    report_lines.append("")

    # 2. Fairness Audit
    report_lines.append("### Fairness Audit")
    stereotypes = fairness_data.get('stereotyping_risks', [])
    if stereotypes:
        report_lines.append("**⚠️ Potential Risks Detected:**")
        for s in stereotypes:
            report_lines.append(f"- {s}")
    else:
        report_lines.append("✅ No overt stereotyping risks detected in this sample.")
    
    rep_stats = fairness_data.get('representation_stats', {})
    if rep_stats:
        report_lines.append("")
        report_lines.append("**Representation Stats:**")
        report_lines.append("```json")
        report_lines.append(json.dumps(rep_stats, indent=2))
        report_lines.append("```")

    report_lines.append("")
    report_lines.append("---")
    report_lines.append("")

# Write to file
with open("ETHICS_REPORT.md", "w") as f:
    f.write("\n".join(report_lines))

print("ETHICS_REPORT.md generated successfully.")
